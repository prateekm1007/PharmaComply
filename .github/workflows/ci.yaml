name: PharmaComply CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  validation:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install PostgreSQL client
      run: sudo apt-get install postgresql-client -y

    - name: Run DB migrations
      run: ./backend/scripts/migrate.sh

    - name: Check schema drift
      run: ./backend/scripts/check_schema_drift.sh

    - name: Verify audit hash chain
      run: ./backend/scripts/check_hash_chain.sh

    - name: Backend tests (placeholder)
      run: pytest -q || echo "no tests yet"

    - name: Verify auth session endpoint
      run: curl -I http://localhost:9999/api/auth/session || exit 0

    - name: Verify Hash Chain
      run: ./backend/scripts/check_hash_chain.sh

    - name: Anchor Chain
      run: ./backend/scripts/anchor_chain_to_ipfs.sh || echo "anchor skipped"
